//
// Endpoint: /sessions/batch
//
// Generated by OpenAPI_JSON_To_Single_Endpoint app.
// Author: Grzegorz Molenda.
// v.3 - 2025, All rights reserved.
// Released under MIT License.
//
  "/sessions/batch" : {
    "post" : {
      "tags" : [
        "Wysyłka wsadowa"
      ],
      "summary" : "Otwarcie sesji wsadowej",
      "description" : "Otwiera sesję do wysyłki wsadowej faktur. Należy przekazać schemat wysyłanych faktur, informacje o paczce faktur oraz informacje o kluczu używanym do szyfrowania.\n\n> Więcej informacji:\n> - [Przygotowanie paczki faktur](https://github.com/CIRFMF/ksef-docs/blob/main/sesja-wsadowa.md)\n> - [Klucz publiczny Ministerstwa Finansów](/docs/v2/index.html#tag/Certyfikaty-klucza-publicznego)\n\nAby generować dokumenty UPO w wersji v4-3 w ramach sesji, należy przy jej otwarciu przesłać nagłówek <b>X-KSeF-Feature: upo-v4-3</b>.\nOd 22 grudnia 2025 wersja UPO v4-3 będzie generowana domyślnie.\n\n**Wymagane uprawnienia**: `InvoiceWrite`, `EnforcementOperations`.",
      "requestBody" : {
        "content" : {
          "application/json" : {
            "schema" : {
              "required" : [
                "formCode",
                "batchFile",
                "encryption"
              ],
              "allOf" : [
                {
                  "$ref" : "#/components/schemas/OpenBatchSessionRequest"
                }
              ]
            },
            "example" : {
              "formCode" : {
                "systemCode" : "FA (2)",
                "schemaVersion" : "1-0E",
                "value" : "FA"
              },
              "batchFile" : {
                "fileSize" : 16037,
                "fileHash" : "WO86CC+1Lef11wEosItld/NPwxGN8tobOMLqk9PQjgs=",
                "fileParts" : [
                  {
                    "ordinalNumber" : 1,
                    "fileSize" : 16048,
                    "fileHash" : "23ZyDAN0H/+yhC/En2xbNfF0tajAWSfejDaXD7fc2AE="
                  }
                ]
              },
              "encryption" : {
                "encryptedSymmetricKey" : "bYqmPAglF01AxZim4oNa+1NerhZYfFgLMnvksBprUur1aesQ0Y5jsmOIfCrozfMkF2tjdO+uOsBg4FPlDgjChwN2/tz2Hqwtxq3RkTr1SjY4x8jxJFpPedcS7EI+XO8C+i9mLj7TFx9p/bg07yM9vHtMAk5b88Ay9Qc3+T5Ch1DM2ClR3sVu2DqdlKzmbINY+rhfGtXn58Qo0XRyESGgc6M0iTZVBRPuPXLnD8a1KpOneCpNzLwxgT6Ei3ivLOpPWT53PxkRTaQ8puj6CIiCKo4FHQzHuI/NmrAhYU7TkNm2kymP/OxBgWdg3XB74tqNFfT8RZN1bZXuPhBidDOqa+xsqY3E871FSDmQwZf58HmoNl31XNvpnryiRGfnAISt+m+ELqgksAresVu6E9poUL1yiff+IOHSZABoYpNiqwnbT8qyW1uk8lKLyFVFu+kOsbzBk1OWWHqSkNFDaznDa2MKjHonOXI0uyKaKWvoBFC4dWN1PVumfpSSFAeYgNpAyVrZdcVOuiliEWepTDjGzJoOafTvwr5za2S6B5bPECDpX7JXazV7Olkq7ezG0w8y3olx+0C+NHoCk8B5/cm4gtVHTgKjiLSGpKJVOJABLXFkOyIOjbQsVe4ryX0Qy+SfL7JIQvTWvM5xkCoOMbzLdMo9tNo5qE34sguFI+lIevY=",
                "initializationVector" : "jWpJLNBHJ5pQEGCBglmIAw=="
              },
              "offlineMode" : false
            }
          }
        }
      },
      "responses" : {
        "201" : {
          "description" : "Created",
          "content" : {
            "application/json" : {
              "schema" : {
                "$ref" : "#/components/schemas/OpenBatchSessionResponse"
              },
              "example" : {
                "referenceNumber" : "20250626-SB-213D593000-4DE10D80A5-E9",
                "partUploadRequests" : [
                  {
                    "ordinalNumber" : 1,
                    "method" : "PUT",
                    "url" : "https://ksef-api-storage/storage/00/20250626-sb-213d593000-4de10d80a5-e9/batch-parts/1?skoid=1ad7cfe8-2cb2-406b-b96c-6eefb55794db&sktid=647754c7-3974-4442-a425-c61341b61c69&skt=2025-06-26T09%3A40%3A54Z&ske=2025-06-26T10%3A10%3A54Z&sks=b&skv=2025-01-05&sv=2025-01-05&se=2025-06-26T10%3A10%3A54Z&sr=b&sp=w&sig=8mKZEU8Reuz%2Fn7wHi4T%2FY8BzLeD5l8bR2xJsBxIgDEY%3D",
                    "headers" : {
                      "x-ms-blob-type" : "BlockBlob"
                    }
                  }
                ]
              }
            }
          }
        },
        "400" : {
          "description" : "| ExceptionCode       | ExceptionDescription                                | Details                                                                   | \n|---------------------|-----------------------------------------------------|---------------------------------------------------------------------------|\n| 21157               | Nieprawidłowy rozmiar części pakietu.               | {treść błędu walidacji}                                                   | \n| 21161               | Przekroczono dozwoloną liczbę części pakietu.       | {treść błędu walidacji}                                                   |\n| 21405 | Błąd walidacji danych wejściowych. | {treść błędu z walidatora} |",
          "content" : {
            "application/json" : {
              "schema" : {
                "$ref" : "#/components/schemas/ExceptionResponse"
              }
            }
          },
          "x-summary" : "Bad Request"
        },
        "429" : {
          "description" : "| | req / s | req / min | req / h | grupa\n| --- | --- | --- | --- | --- |\n| **Limity liczby żądań** | 100 | 200 | 600 | batchSession\n",
          "headers" : {
            "Retry-After" : {
              "schema" : {
                "$ref" : "#/components/schemas/RetryAfter"
              }
            }
          },
          "content" : {
            "application/json" : {
              "schema" : {
                "$ref" : "#/components/schemas/TooManyRequestsResponse"
              }
            }
          },
          "x-summary" : "Too Many Requests"
        },
        "403" : {
          "description" : "Forbidden"
        },
        "401" : {
          "description" : "Unauthorized"
        }
      },
      "security" : [
        {
          "Bearer" : [

          ]
        }
      ],
      "x-rate-limits" : {
        "perSecond" : 100,
        "perMinute" : 200,
        "perHour" : 600
      },
      "x-required-permissions" : [
        "InvoiceWrite",
        "EnforcementOperations"
      ]
    }
  }


  "OpenBatchSessionRequest" : {
    "required" : [
      "batchFile",
      "encryption",
      "formCode"
    ],
    "type" : "object",
    "properties" : {
      "formCode" : {
        "required" : [
          "systemCode",
          "schemaVersion",
          "value"
        ],
        "allOf" : [
          {
            "$ref" : "#/components/schemas/FormCode"
          }
        ],
        "description" : "Schemat faktur wysyłanych w ramach sesji.\n\nObsługiwane schematy:\n| SystemCode | SchemaVersion | Value |\n| --- | --- | --- |\n| [FA (2)](https://github.com/CIRFMF/ksef-docs/blob/main/faktury/schemy/FA/schemat_FA(2)_v1-0E.xsd) | 1-0E | FA |\n| [FA (3)](https://github.com/CIRFMF/ksef-docs/blob/main/faktury/schemy/FA/schemat_FA(3)_v1-0E.xsd) | 1-0E | FA |\n"
      },
      "batchFile" : {
        "required" : [
          "fileSize",
          "fileHash",
          "fileParts"
        ],
        "allOf" : [
          {
            "$ref" : "#/components/schemas/BatchFileInfo"
          }
        ],
        "description" : "Informacje o przesyłanej paczce faktur."
      },
      "encryption" : {
        "required" : [
          "encryptedSymmetricKey",
          "initializationVector"
        ],
        "allOf" : [
          {
            "$ref" : "#/components/schemas/EncryptionInfo"
          }
        ],
        "description" : "Symetryczny klucz szyfrujący plik paczki, zaszyfrowany kluczem publicznym Ministerstwa Finansów."
      },
      "offlineMode" : {
        "type" : "boolean",
        "description" : "Określa, czy podatnik deklaruje tryb fakturowania \"offline\" dla dokumentów przesyłanych w sesji wsadowej.",
        "default" : false
      }
    },
    "additionalProperties" : false
  }


  "FormCode" : {
    "required" : [
      "schemaVersion",
      "systemCode",
      "value"
    ],
    "type" : "object",
    "properties" : {
      "systemCode" : {
        "type" : "string",
        "description" : "Kod systemowy"
      },
      "schemaVersion" : {
        "type" : "string",
        "description" : "Wersja schematu"
      },
      "value" : {
        "type" : "string",
        "description" : "Wartość"
      }
    },
    "additionalProperties" : false
  }


  "BatchFileInfo" : {
    "required" : [
      "fileHash",
      "fileParts",
      "fileSize"
    ],
    "type" : "object",
    "properties" : {
      "fileSize" : {
        "maximum" : 5000000000,
        "minimum" : 1,
        "type" : "integer",
        "description" : "Rozmiar pliku paczki w bajtach. Maksymalny rozmiar paczki to 5GB.",
        "format" : "int64"
      },
      "fileHash" : {
        "allOf" : [
          {
            "$ref" : "#/components/schemas/Sha256HashBase64"
          }
        ],
        "description" : "Skrót SHA256 pliku paczki, zakodowany w formacie Base64."
      },
      "fileParts" : {
        "maxItems" : 50,
        "minItems" : 1,
        "type" : "array",
        "items" : {
          "$ref" : "#/components/schemas/BatchFilePartInfo"
        },
        "description" : "Informacje o częściach pliku paczki. Maksymalna liczba części to 50. Maksymalny dozwolony rozmiar części przed zaszyfrowaniem to 100MB."
      }
    },
    "additionalProperties" : false
  }


  "Sha256HashBase64" : {
    "maxLength" : 44,
    "minLength" : 44,
    "type" : "string",
    "description" : "SHA-256 w Base64.",
    "format" : "byte"
  }


  "BatchFilePartInfo" : {
    "required" : [
      "fileHash",
      "fileSize",
      "ordinalNumber"
    ],
    "type" : "object",
    "properties" : {
      "ordinalNumber" : {
        "minimum" : 1,
        "type" : "integer",
        "description" : "Numer sekwencyjny części pliku paczki.",
        "format" : "int32"
      },
      "fileSize" : {
        "minimum" : 1,
        "type" : "integer",
        "description" : "Rozmiar zaszyfrowanej części pliku paczki w bajtach.",
        "format" : "int64"
      },
      "fileHash" : {
        "allOf" : [
          {
            "$ref" : "#/components/schemas/Sha256HashBase64"
          }
        ],
        "description" : "Skrót SHA256 zaszyfrowanej części pliku paczki, zakodowany w formacie Base64."
      }
    },
    "additionalProperties" : false
  }


  "EncryptionInfo" : {
    "required" : [
      "encryptedSymmetricKey",
      "initializationVector"
    ],
    "type" : "object",
    "properties" : {
      "encryptedSymmetricKey" : {
        "type" : "string",
        "description" : "Klucz symetryczny o długości 32 bajtów, zaszyfrowany algorytmem RSA (Padding: OAEP z SHA-256), zakodowany w formacie Base64.\n\n[Klucz publiczny Ministerstwa Finansów](/docs/v2/index.html#tag/Certyfikaty-klucza-publicznego)",
        "format" : "byte"
      },
      "initializationVector" : {
        "type" : "string",
        "description" : "Wektor inicjalizujący (IV) o długości 16 bajtów, używany do szyfrowania symetrycznego, zakodowany w formacie Base64.",
        "format" : "byte"
      }
    },
    "additionalProperties" : false
  }


  "OpenBatchSessionResponse" : {
    "required" : [
      "partUploadRequests",
      "referenceNumber"
    ],
    "type" : "object",
    "properties" : {
      "referenceNumber" : {
        "allOf" : [
          {
            "$ref" : "#/components/schemas/ReferenceNumber"
          }
        ],
        "description" : "Numer referencyjny sesji."
      },
      "partUploadRequests" : {
        "type" : "array",
        "items" : {
          "$ref" : "#/components/schemas/PartUploadRequest"
        },
        "description" : "Dane wymagane do poprawnego przesłania poszczególnych części pliku paczki faktur.\n\nKażdą część pliku paczki zadeklarowaną w <b>fileParts</b> należy przesłać zgodnie z odpowiadającym jej obiektem w <b>partUploadRequests</b>.\nŁącznikiem pomiędzy deklaracją a instrukcją wysyłki jest pole <b>ordinalNumber</b>.\n\nDla każdej części należy:\n* zastosować metodę HTTP wskazaną w <b>method</b>,\n* ustawić adres z <b>url</b>,\n* dołączyć nagłówki z <b>headers</b>,\n* dołączyć treść części pliku w korpusie żądania.\n\n`Uwaga: nie należy dodawać do nagłówków token dostępu (accessToken).`\n \nKażdą część przesyła się oddzielnym żądaniem HTTP.Zwracane kody odpowiedzi:\n * <b>201</b> – poprawne przyjęcie pliku,\n * <b>400</b> – błędne dane,\n * <b>401</b> – nieprawidłowe uwierzytelnienie,\n * <b>403</b> – brak uprawnień do zapisu (np.upłynął czas na zapis)."
      }
    },
    "additionalProperties" : false
  }


  "ReferenceNumber" : {
    "maxLength" : 36,
    "minLength" : 36,
    "type" : "string",
    "description" : "Numer referencyjny."
  }


  "PartUploadRequest" : {
    "required" : [
      "headers",
      "method",
      "ordinalNumber",
      "url"
    ],
    "type" : "object",
    "properties" : {
      "ordinalNumber" : {
        "minimum" : 1,
        "type" : "integer",
        "description" : "Numer sekwencyjny części pliku paczki.",
        "format" : "int32"
      },
      "method" : {
        "type" : "string",
        "description" : "Metoda HTTP, której należy użyć przy wysyłce części pliku paczki."
      },
      "url" : {
        "type" : "string",
        "description" : "Adres pod który należy wysłać część pliku paczki.",
        "format" : "uri"
      },
      "headers" : {
        "type" : "object",
        "additionalProperties" : {
          "type" : "string",
          "nullable" : true
        },
        "description" : "Nagłówki, których należy użyć przy wysyłce części pliku paczki."
      }
    },
    "additionalProperties" : false
  }



//---------------------------------------------------------------------------------------------------
request: "/sessions/batch": post: application/json
headers:
Authorization: Bearer {securityToken}
body:
{
  "formCode": { // required; type: object; items: #/components/schemas/FormCode; description: Schemat faktur wysyłanych w ramach sesji.

Obsługiwane schematy:
| SystemCode | SchemaVersion | Value |
| --- | --- | --- |
| [FA (2)](https://github.com/CIRFMF/ksef-docs/blob/main/faktury/schemy/FA/schemat_FA(2)_v1-0E.xsd) | 1-0E | FA |
| [FA (3)](https://github.com/CIRFMF/ksef-docs/blob/main/faktury/schemy/FA/schemat_FA(3)_v1-0E.xsd) | 1-0E | FA |
    "systemCode": "", // required; type: string; description: Kod systemowy
    "schemaVersion": "", // required; type: string; description: Wersja schematu
    "value": "" // required; type: string; description: Wartość
  },
  "batchFile": { // required; type: object; items: #/components/schemas/BatchFileInfo; description: Informacje o przesyłanej paczce faktur.
    "fileSize": 0, // required; type: integer; format: int64; description: Rozmiar pliku paczki w bajtach. Maksymalny rozmiar paczki to 5GB.
    "fileHash": "", // required; type: string; items: #/components/schemas/Sha256HashBase64; description: Skrót SHA256 pliku paczki, zakodowany w formacie Base64.
    "fileParts": [ // required; type: array; description: Informacje o częściach pliku paczki. Maksymalna liczba części to 50. Maksymalny dozwolony rozmiar części przed zaszyfrowaniem to 100MB.
      {
        "ordinalNumber": 0, // required; type: integer; format: int32; description: Numer sekwencyjny części pliku paczki.
        "fileSize": 0, // required; type: integer; format: int64; description: Rozmiar zaszyfrowanej części pliku paczki w bajtach.
        "fileHash": "" // required; type: string; items: #/components/schemas/Sha256HashBase64; description: Skrót SHA256 zaszyfrowanej części pliku paczki, zakodowany w formacie Base64.
      }
    ]
  },
  "encryption": { // required; type: object; items: #/components/schemas/EncryptionInfo; description: Symetryczny klucz szyfrujący plik paczki, zaszyfrowany kluczem publicznym Ministerstwa Finansów.
    "encryptedSymmetricKey": "", // required; type: string; format: byte; description: Klucz symetryczny o długości 32 bajtów, zaszyfrowany algorytmem RSA (Padding: OAEP z SHA-256), zakodowany w formacie Base64.

[Klucz publiczny Ministerstwa Finansów](/docs/v2/index.html#tag/Certyfikaty-klucza-publicznego)
    "initializationVector": "" // required; type: string; format: byte; description: Wektor inicjalizujący (IV) o długości 16 bajtów, używany do szyfrowania symetrycznego, zakodowany w formacie Base64.
  },
  "offlineMode": true/false // type: boolean; description: Określa, czy podatnik deklaruje tryb fakturowania "offline" dla dokumentów przesyłanych w sesji wsadowej.
}



response (201): application/json
{
  "referenceNumber": "", // required; type: string; items: #/components/schemas/ReferenceNumber; description: Numer referencyjny sesji.
  "partUploadRequests": [ // required; type: array; description: Dane wymagane do poprawnego przesłania poszczególnych części pliku paczki faktur.

Każdą część pliku paczki zadeklarowaną w <b>fileParts</b> należy przesłać zgodnie z odpowiadającym jej obiektem w <b>partUploadRequests</b>.
Łącznikiem pomiędzy deklaracją a instrukcją wysyłki jest pole <b>ordinalNumber</b>.

Dla każdej części należy:
* zastosować metodę HTTP wskazaną w <b>method</b>,
* ustawić adres z <b>url</b>,
* dołączyć nagłówki z <b>headers</b>,
* dołączyć treść części pliku w korpusie żądania.

`Uwaga: nie należy dodawać do nagłówków token dostępu (accessToken).`
 
Każdą część przesyła się oddzielnym żądaniem HTTP.Zwracane kody odpowiedzi:
 * <b>201</b> – poprawne przyjęcie pliku,
 * <b>400</b> – błędne dane,
 * <b>401</b> – nieprawidłowe uwierzytelnienie,
 * <b>403</b> – brak uprawnień do zapisu (np.upłynął czas na zapis).
    {
      "ordinalNumber": 0, // required; type: integer; format: int32; description: Numer sekwencyjny części pliku paczki.
      "method": "", // required; type: string; description: Metoda HTTP, której należy użyć przy wysyłce części pliku paczki.
      "url": "", // required; type: string; format: uri; description: Adres pod który należy wysłać część pliku paczki.
      "headers": { // required; type: object; nullable: true; description: Nagłówki, których należy użyć przy wysyłce części pliku paczki.
      }
    }
  ]
}
